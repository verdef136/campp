<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campionato — Classifica minimal (calcolo automatico)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --accent:#0ea5a4;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; color:#0f172a}
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .brand{font-weight:700;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(12,16,30,0.06)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;text-align:left}
    th{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase}
    tr:not(:first-child):hover{background:rgba(14,165,164,0.04)}
    .pos{width:34px;text-align:center;font-weight:700}
    .team{display:flex;gap:10px;align-items:center}
    .badge{width:32px;height:32px;border-radius:6px;background:#eef2f7;display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:#334155;object-fit:contain}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{background:transparent;border:1px solid #e6e9ef;padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:white;border-color:transparent}
    .scorers{list-style:none;padding:0;margin:0}
    .scorers li{padding:8px 0;border-bottom:1px dashed #eef2f7;display:flex;justify-content:space-between}
    .muted{color:var(--muted)}
    textarea{width:100%;min-height:160px;font-family:monospace;font-size:13px;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    .small-note{font-size:12px;color:var(--muted);margin-top:8px}
    .matchday{margin-bottom:12px;border-top:1px solid #f1f5f9;padding-top:10px}
    .match{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
    .match .teams{display:flex;gap:8px;align-items:center}
    .match .score{font-weight:700;min-width:64px;text-align:center}
    .match .scorers{font-size:13px;color:var(--muted);margin-top:4px}
    @media (max-width:820px){.grid{grid-template-columns:1fr;}.wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Campionato — Minimal</div>
      <div class="subtitle">Classifica calcolata automaticamente dalle giornate</div>
    </header>

    <div class="grid">
      <main class="card">
        <h2 style="margin-top:0;margin-bottom:6px">Classifica</h2>
        <div class="small">I dati vengono salvati localmente nel browser — modifica il JSON a destra e premi <strong>Applica dati</strong>. La classifica e i marcatori vengono calcolati automaticamente dalle <em>matchdays</em>.</div>

        <div style="overflow:auto;margin-top:12px">
          <table id="table-standings" aria-label="Classifica">
            <thead>
              <tr>
                <th class="pos">#</th>
                <th>Squadra</th>
                <th>P</th>
                <th>V</th>
                <th>N</th>
                <th>Per</th>
                <th>Gol Fatti</th>
                <th>Gol Subiti</th>
                <th>Diff. Reti</th>
                <th>Pt</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="controls">
          <button class="btn" onclick="sortBy('pts')">Ordina per Punti</button>
          <button class="btn" onclick="sortBy('gd')">Ordina per Diff. Reti</button>
          <button class="btn" onclick="sortBy('gf')">Ordina per Gol</button>
          <button class="btn" onclick="clearStorage()">Cancella salvataggio</button>
        </div>
      </main>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Migliori marcatori</h3>
          <ul id="scorers" class="scorers"></ul>
          <div class="small-note">Clicca su un marcatore per evidenziare la sua squadra nella classifica.</div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Dati (JSON)</h3>
          <textarea id="json-data"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" onclick="applyData()">Applica dati</button>
            <button class="btn" onclick="downloadHTML()">Scarica .html</button>
            <button class="btn" onclick="computeFromMatchdaysAndUpdateTextarea()">Calcola da giornate</button>
          </div>
          <div class="small-note">Modifica i valori se vuoi — teams (solo per mapping id→nome/logo), matchdays. Premi <strong>Calcola da giornate</strong> o <strong>Applica dati</strong>.</div>
        </div>
      </aside>

      <!-- Ultime giornate -->
      <section class="card" style="grid-column:1 / -1; margin-top:18px">
        <h2 style="margin-top:0;margin-bottom:6px">Ultime Giornate</h2>
        <div id="matchdays"></div>
      </section>

    </div>
  </div>

  <script>
    // --- Dati iniziali (corretti) ---
    const initialData = {
      // teams array used mainly for mapping id -> name/logo. The computed standings will override win/draw/loss/gf/ga
      teams: [
        { id: 'MC', name: 'Manchester City' },
        { id: 'S', name: 'Santos' },
        { id: 'N', name: 'Napoli' },
        { id: 'AM', name: 'Atletico Madrid' }
      ],
      // scorers will be computed from matchdays
      scorers: [],
      // matchdays (corretti)
      matchdays: [
        {
          giornata: 1,
          date: "",
          matches: [
            { homeId: 'MC', awayId: 'AM', score: '1-1', scorersHome: ['Paul Pogba'], scorersAway: ['Cristiano Ronaldo'] },
            { homeId: 'S', awayId: 'N', score: '1-4', scorersHome: ['Robert Lewandowski'], scorersAway: ['Kylian Mbappé','Kylian Mbappé','Kylian Mbappé','Kylian Mbappé'] }
          ]
        },
        {
          giornata: 2,
          date: "",
          matches: [
            { homeId: 'AM', awayId: 'N', score: '1-1', scorersHome: ['Vinicius'], scorersAway: ['Timo Werner'] },
            { homeId: 'MC', awayId: 'S', score: '4-6', scorersHome: ['Paulo Dybala','Marco Verratti','Erling Haaland','Erling Haaland'], scorersAway: ['Lionel Messi','João Félix','Robert Lewandowski','Robert Lewandowski','Karim Benzema','Karim Benzema'] }
          ]
        },
        {
          giornata: 3,
          date: "",
          matches: [
            { homeId: 'AM', awayId: 'S', score: '5-0', scorersHome: ['Ousmane Dembélé','Ousmane Dembélé','Cristiano Ronaldo','Vinicius','Marcus Rashford'], scorersAway: [] },
            { homeId: 'MC', awayId: 'N', score: '0-4', scorersHome: [], scorersAway: ['Kylian Mbappé','Kylian Mbappé','Kylian Mbappé','Heung-min Son'] }
          ]
        },
        {
          giornata: 4,
          date: "",
          matches: [
            { homeId: 'MC', awayId: 'N', score: '0-4', scorersHome: [], scorersAway: ['Kylian Mbappé','Kylian Mbappé','Kylian Mbappé','Kylian Mbappé'] },
            { homeId: 'AM', awayId: 'S', score: '4-2', scorersHome: ['Ousmane Dembélé','Cristiano Ronaldo','Cristiano Ronaldo','Riyad Mahrez'], scorersAway: ['Neymar Jr','Robert Lewandowski'] }
          ]
        },
        {
          giornata: 5,
          date: "",
          matches: [
            { homeId: 'MC', awayId: 'S', score: '2-2', scorersHome: ['Silva','Rafael Leão'], scorersAway: ['Neymar Jr','Karim Benzema'] },
            { homeId: 'AM', awayId: 'N', score: '3-2', scorersHome: ['Antoine Griezmann','Antoine Griezmann','Eden Hazard'], scorersAway: ['Kylian Mbappé','Raheem Sterling'] }
          ]
        }
      ]
    };

    // Utility to deep clone
    function clone(v){ return JSON.parse(JSON.stringify(v)); }

    // Parse score string "x-y" -> [x, y] (numbers)
    function parseScore(score){
      if(!score || typeof score !== 'string') return [0,0];
      const parts = score.split('-').map(s=>parseInt(s.trim(),10));
      if(parts.length!==2 || isNaN(parts[0]) || isNaN(parts[1])) return [0,0];
      return parts;
    }

    // Compute teams stats and scorers from matchdays
    function computeFromMatchdays(rawData){
      // rawData should contain .teams (optional mapping) and .matchdays
      const teamMap = new Map(); // id -> { id, name, played, win, draw, loss, gf, ga }
      // preload known teams (for names)
      if(Array.isArray(rawData.teams)){
        rawData.teams.forEach(t=>{
          if(t && t.id){
            teamMap.set(t.id, { id: t.id, name: t.name || t.id, played:0, win:0, draw:0, loss:0, gf:0, ga:0 });
          }
        });
      }

      const scorerMap = new Map(); // playerName -> { player, teamId, goals }

      const mds = Array.isArray(rawData.matchdays) ? rawData.matchdays : [];

      mds.forEach(md=>{
        (md.matches || []).forEach(m=>{
          const homeId = m.homeId;
          const awayId = m.awayId;
          // ensure teams exist in map
          if(!teamMap.has(homeId)) teamMap.set(homeId, { id: homeId, name: homeId, played:0, win:0, draw:0, loss:0, gf:0, ga:0 });
          if(!teamMap.has(awayId)) teamMap.set(awayId, { id: awayId, name: awayId, played:0, win:0, draw:0, loss:0, gf:0, ga:0 });
          const home = teamMap.get(homeId);
          const away = teamMap.get(awayId);

          const [hg, ag] = parseScore(m.score);

          // update matches played and goals
          home.played += 1; away.played += 1;
          home.gf += hg; home.ga += ag;
          away.gf += ag; away.ga += hg;

          // result
          if(hg > ag){
            home.win += 1; away.loss += 1;
          } else if(hg < ag){
            away.win += 1; home.loss += 1;
          } else {
            home.draw += 1; away.draw += 1;
          }

          // scorers: count occurrences in arrays (each occurrence = 1 goal)
          const homeScorers = Array.isArray(m.scorersHome) ? m.scorersHome : [];
          const awayScorers = Array.isArray(m.scorersAway) ? m.scorersAway : [];

          // Count each listed scorer (handles repeated names)
          homeScorers.forEach(name=>{
            if(!name) return;
            const key = name.trim();
            const entry = scorerMap.get(key) || { player: key, teamId: homeId, goals: 0 };
            entry.goals += 1;
            // prefer keeping teamId if already set; but if mismatch, keep first
            if(!entry.teamId) entry.teamId = homeId;
            scorerMap.set(key, entry);
          });

          awayScorers.forEach(name=>{
            if(!name) return;
            const key = name.trim();
            const entry = scorerMap.get(key) || { player: key, teamId: awayId, goals: 0 };
            entry.goals += 1;
            if(!entry.teamId) entry.teamId = awayId;
            scorerMap.set(key, entry);
          });
        });
      });

      // convert teamMap to array and compute pts/gd
      const teams = Array.from(teamMap.values()).map(t=>{
        const pts = (t.win||0)*3 + (t.draw||0);
        const gd = (t.gf||0) - (t.ga||0);
        return {...t, pts, gd};
      });

      // convert scorerMap to array and sort
      const scorers = Array.from(scorerMap.values()).sort((a,b)=> b.goals - a.goals || a.player.localeCompare(b.player));

      return { teams, scorers, matchdays: mds };
    }

    // Renders
    function renderStandings(data){
      const tbody = document.querySelector('#table-standings tbody');
      tbody.innerHTML = '';
      const teams = (data.teams || []).slice().sort((a,b)=> b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.name.localeCompare(b.name));
      teams.forEach((t,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.teamId = t.id;
        tr.innerHTML = `
          <td class="pos">${i+1}</td>
          <td>
            <div class="team">
              <img src="images/${t.id}.png" alt="${t.name} logo" class="badge" onerror="this.style.display='inline-block'; this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAR0lEQVR4nO3RMQ0AAAjDMO5fNNSwY8Q0cSgkQwYMGDBgwIABAwYMGCBAwYMGDBgwIABAwYMGCBAwYMGDBgwIABAwYMG
